# Set working directory to parent directory (i.e: main directory for this project)
# Snakemake complains sometimes when working with files in parent directories...
import os
os.chdir(os.path.dirname(os.getcwd()))  # set working dir to parent dir

# Global variables
# TODO - move these to a config file
singularity: "singularity/container.sif"
PROTEOMES = 'data/proteomes'
ALL_V_ALL_ALGO = 'blast'
REFERENCE_SPECIES = 'E_brev'
PFAM_LIB = "data/pfam/Pfam-A.hmm"

rule all:
	input: "results/hmmscan"

rule run_orthofinder:
	input: PROTEOMES
	output: directory("results/OrthoFinder")
	shell:
		"""
		orthofinder -f {input} -og -S {ALL_V_ALL_ALGO} -o {output} -n OrthoFinder
		"""

rule get_single_copy_orthogroups:
	# From Orthogroups.tsv from OrthoFinder, filter the orthogroups to
	# those with a single-copy ortholog in yeast and a single-copy
	# ortholog from *any* other species
	input: "results/OrthoFinder"
	output: "results/single_copy_orthogroups.csv", "resources/orthogroups_for_hmmscan"
	shell:
		"""
		Rscript workflow/scripts/get_single_copy_orthogroups.R {input} {REFERENCE_SPECIES} {output}
		"""
		
rule create_hmmscan_commands:
	input: "resources/orthogroups_for_hmmscan"
	output: "resources/hmmscan_commands"
	shell:
		"""
		touch resources/tmp
		
		while read orthogroup; do
			echo hmmscan -o results/hmmscan/"$orthogroup" \
			--cut_ga {PFAM_LIB} \
			results/OrthoFinder/Results_OrthoFinder/Orthogroup_Sequences/"$orthogroup".fa >> resources/tmp
		done < {input}
		
		mv resources/tmp {output}
		"""
		
# note: I could've done this step without the pre-made commands file, and using
# wildcards to create the hmmscan output for each orthogroup, but that lead
# to Snakemake taking insanely long to build a DAG
#
# TODO: maybe replace input with function for finding acceptable orthogroups
rule run_hmmscan_on_single_copy_orthogroups:
	input: "resources/hmmscan_commands"
	output: directory("results/hmmscan")
	shell:
		"""
		mkdir {output}
		parallel < {input}
		"""
	
rule get_domain_architectures_from_hmmscan:
	input: "results/hmmscan/{orthogroup}"
	output: "results/domain_architectures/{orthogroup}"
	shell:
		"""
		workflow/scripts/run_cath_resolve_hits.sh {input} {output}
		"""
		
rule align_orthogroup_domain_architectures:
	input: "results/domain_architectures"
	output: "results/aligned_orthogroup_domain_architectures.csv"
	shell:
		"""
		Rscript workflow/scripts/align_domain_architectures.R {input} {output}
		"""

rule singularity_test:
	# run "snakemake --cores all --use-singularity singularity_test"
	# to ensure all required software can be called without error from
	# the Singularity container
	shell:
        	"""
        	cath-resolve-hits -h
        	blastp -help
        	diamond help
        	hmmscan -h
        	orthofinder -h
        	R --slave -e 'library(tidyverse)'
        	"""
